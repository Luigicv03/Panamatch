// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuario (autenticación)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  profile   Profile?

  @@map("users")
}

// Modelo de Perfil
model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName   String
  lastName    String
  dateOfBirth DateTime
  gender      String
  city        String
  bio         String?  @db.Text
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  interests   UserInterest[]
  swipes      Swipe[]         @relation("SwipedBy")
  receivedSwipes Swipe[]      @relation("SwipedOn")
  matchesAsUser1 Match[]      @relation("User1")
  matchesAsUser2 Match[]      @relation("User2")
  chatsAsUser1 Chat[]         @relation("User1")
  chatsAsUser2 Chat[]         @relation("User2")
  messages    Message[]
  media       Media[]

  @@map("profiles")
}

// Modelo de Intereses
model Interest {
  id          String   @id @default(uuid())
  name        String   @unique
  icon        String?
  createdAt   DateTime @default(now())
  userInterests UserInterest[]

  @@map("interests")
}

// Relación N:N entre Usuarios e Intereses
model UserInterest {
  id         String   @id @default(uuid())
  userId     String
  interestId String
  profile    Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([userId, interestId])
  @@map("user_interests")
}

// Modelo de Swipes
model Swipe {
  id        String   @id @default(uuid())
  swipedBy  String
  swipedOn  String
  action    String   // 'like' o 'dislike'
  createdAt DateTime @default(now())

  profileSwipedBy Profile @relation("SwipedBy", fields: [swipedBy], references: [id], onDelete: Cascade)
  profileSwipedOn Profile @relation("SwipedOn", fields: [swipedOn], references: [id], onDelete: Cascade)

  @@unique([swipedBy, swipedOn])
  @@map("swipes")
}

// Modelo de Matches
model Match {
  id        String   @id @default(uuid())
  user1Id   String
  user2Id   String
  createdAt DateTime @default(now())

  user1     Profile  @relation("User1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2     Profile  @relation("User2", fields: [user2Id], references: [id], onDelete: Cascade)
  chat      Chat?

  @@unique([user1Id, user2Id])
  @@map("matches")
}

// Modelo de Chats
model Chat {
  id           String   @id @default(uuid())
  matchId      String?  @unique
  user1Id      String
  user2Id      String
  lastMessage  String?
  lastMessageAt DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  match        Match?   @relation(fields: [matchId], references: [id], onDelete: SetNull)
  user1        Profile  @relation("User1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2        Profile  @relation("User2", fields: [user2Id], references: [id], onDelete: Cascade)
  messages     Message[]

  @@unique([user1Id, user2Id])
  @@map("chats")
}

// Modelo de Mensajes
model Message {
  id        String   @id @default(uuid())
  chatId    String
  senderId  String
  content   String?  @db.Text
  mediaId   String?  @unique
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender    Profile  @relation(fields: [senderId], references: [id], onDelete: Cascade)
  media     Media?

  @@map("messages")
}

// Modelo de Media (imágenes)
model Media {
  id          String   @id @default(uuid())
  profileId   String?
  messageId   String?  @unique
  url         String
  type        String   // 'profile' o 'message'
  mimeType    String
  size        Int?
  createdAt   DateTime @default(now())

  profile     Profile? @relation(fields: [profileId], references: [id], onDelete: Cascade)
  message     Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@map("media")
}

